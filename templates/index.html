<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IM Solutions AI Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ensure input row compacts well on small screens */
        #user-input { min-width: 0; }
        .send-button { min-width: 84px; }
        
        .magical-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        .magical-gradient-reverse {
            background: linear-gradient(135deg, #f093fb 0%, #764ba2 50%, #667eea 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glow-effect {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        .message {
            max-width: 85%;
            margin: 8px 0;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            transition: all 0.3s ease;
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            margin-left: auto;
            margin-right: 0;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .bot-message {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            margin-right: auto;
            margin-left: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .bot-message:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .read-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 12px;
            opacity: 0.7;
        }
        
        .read-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(102, 126, 234, 0.4);
            opacity: 1;
        }
        
        .bot-message:hover .read-btn {
            opacity: 1;
        }
        
        .quick-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            margin: 4px 4px 4px 0;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .quick-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .voice-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 0 12px 12px 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }
        
        .voice-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #calendar-container {
            display: none;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            height: 300px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .fc-event {
            cursor: pointer;
        }
        
        .scheduling-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }
        
        #chat-messages {
            height: 350px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Responsive Chat Window */
        #chatbot-window {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 88vw;
            max-width: 360px;
            height: 70vh;
            max-height: 560px;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 40px rgba(102, 126, 234, 0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 640px) {
            #chatbot-window {
                width: 100vw;
                height: 100vh;
                bottom: 0;
                right: 0;
                left: 0;
                border-radius: 0;
                max-width: none;
                max-height: none;
            }
            
            .scheduling-form {
                width: 95vw;
                max-width: none;
                margin: 10px;
                max-height: 80vh;
            }
            
            .message {
                max-width: 92%;
                font-size: 14px;
                padding: 12px 16px;
                margin: 8px 0;
            }
            
            .quick-btn {
                font-size: 13px;
                padding: 8px 14px;
                margin: 4px 4px 4px 0;
                min-height: 36px;
            }
            
            .form-container {
                width: 95vw;
                max-width: none;
                margin: 10px;
                padding: 24px;
            }
            
            .form-input {
                font-size: 16px;
                padding: 16px 20px;
                margin-bottom: 16px;
            }
            
            .form-button {
                padding: 16px 20px;
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .header-btn {
                padding: 10px 14px;
                min-width: 48px;
                min-height: 48px;
                font-size: 16px;
            }
            
            #user-input {
                font-size: 16px;
                padding: 12px 16px;
                min-height: 48px;
            }
            
            .voice-btn {
                padding: 12px 16px;
                min-width: 48px;
                min-height: 48px;
                font-size: 16px;
            }
            
            .send-button {
                padding: 12px 20px;
                min-height: 48px;
                font-size: 16px;
            }
            
            /* Improve touch targets */
            .quick-btn, .header-btn, .voice-btn, .send-button {
                touch-action: manipulation;
            }
            
            /* Better spacing for mobile */
            #chat-messages {
                padding: 16px;
                margin: 0 16px 16px 16px;
            }
            
            .input-row {
                padding: 16px;
                gap: 8px;
            }
            
            /* Full screen chatbot header */
            #chatbot-window .flex.items-center.justify-between {
                padding: 16px;
                margin-bottom: 0;
            }
        }
        
        @media (min-width: 641px) and (max-width: 1024px) {
            #chatbot-window {
                width: 85vw;
                max-width: 480px;
                height: 75vh;
                max-height: 600px;
            }
            
            .scheduling-form {
                width: 80vw;
                max-width: 400px;
                max-height: 75vh;
            }
            
            .form-container {
                width: 80vw;
                max-width: 400px;
            }
            
            .message {
                max-width: 88%;
                font-size: 14px;
                padding: 12px 16px;
            }
            
            .quick-btn {
                font-size: 13px;
                padding: 8px 14px;
                min-height: 40px;
            }
            
            .input-row {
                padding: 16px;
                gap: 12px;
            }
            
            #user-input {
                font-size: 15px;
                padding: 12px 16px;
                min-height: 44px;
            }
            
            .voice-btn, .send-button {
                padding: 12px 18px;
                min-height: 44px;
                font-size: 15px;
            }
        }
        
        @media (min-width: 1025px) {
            #chatbot-window { width: 360px; height: 560px; }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .quick-btn:hover {
                background: rgba(255, 255, 255, 0.1);
                transform: none;
            }
            
            .form-button:hover {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            }
            
            .form-button.secondary:hover {
                background: rgba(255, 255, 255, 0.2);
            }
        }
        
        /* Form overlay styles */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none;
            backdrop-filter: blur(10px);
        }
        
        /* Professional form styling */
        .form-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 86vw;
            max-width: 360px;
            background: linear-gradient(135deg, hsl(240, 28%, 14%) 0%, #16213e 100%);
            border-radius: 18px;
            padding: 22px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            animation: formSlideIn 0.3s ease-out;
        }
        
        @keyframes formSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
        
        .form-title { font-size: 1.25rem; }
        .form-subtitle { font-size: 0.95rem; margin-bottom: 1.2rem; }
        .form-input { padding: 12px 14px; font-size: 14px; border-radius: 12px; margin-bottom: 12px; }
        .form-button { padding: 12px 14px; font-size: 14px; border-radius: 12px; }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-1px);
        }
        
        .form-button {
            width: 100%;
            padding: 14px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .form-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .form-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 0.8rem;
            box-shadow: none;
        }
        
        .form-button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Loading animation */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced floating chat button */
        #chatbot-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 50;
        }
        
        #chatbot-toggle button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            border-radius: 50%;
            padding: 18px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            border: none;
            font-size: 22px;
            position: relative;
            overflow: hidden;
        }
        
        #chatbot-toggle button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        #chatbot-toggle button:hover::before {
            left: 100%;
        }
        
        #chatbot-toggle button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }
        
        /* Input styling */
        #user-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 12px 0 0 12px;
            padding: 16px 20px;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }
        
        #user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        #user-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }
        
        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 0 12px 12px 0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }
        
        /* Read button styling */
        .read-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 14px;
        }
        
        .read-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
        }
        
        /* Navigation styling */
        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .nav-link.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        /* Hero section styling */
        .hero-gradient {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 50%, rgba(240, 147, 251, 0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }
        /* Restore site sections visibility */
        nav, section { display: block !important; }
        /* Chatbot overlay positioning */
        #chatbot-window { position: fixed; z-index: 1000; }
        
        /* Keep input row pinned to bottom inside chat window */
        #chatbot-window .input-row { position: sticky; bottom: 0; }

        /* General message font size a bit smaller */
        .message { font-size: 14px; }

        /* Make quick buttons a touch smaller */
        .quick-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 18px;
            padding: 6px 12px;
            margin: 0; /* remove extra margins; container gap will handle spacing */
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        /* Smaller header title/subtitle */
        #chatbot-window .header-title { font-size: 16px; }
        #chatbot-window .header-subtitle { font-size: 12px; color: rgba(255,255,255,0.75); }

        /* Slightly smaller send button and input text */
        #user-input { font-size: 14px; }
        .send-button { padding: 12px 18px; font-size: 14px; }
        .voice-btn { padding: 10px 12px; }

        /* Reduce default chat window size a bit */
        #chatbot-window {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 88vw;
            max-width: 360px;
            height: 70vh;
            max-height: 560px;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 40px rgba(102, 126, 234, 0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }

        @media (max-width: 640px) {
            #chatbot-window {
                width: 92vw;
                height: 75vh;
                bottom: 10px;
                right: 10px;
                left: 10px;
                border-radius: 16px;
            }
            .message { font-size: 13px; padding: 10px 14px; }
            .quick-btn { font-size: 12px; padding: 6px 12px; }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            #chatbot-window {
                width: 80vw;
                max-width: 420px;
                height: 65vh;
            }
        }

        @media (min-width: 1025px) {
            #chatbot-window { width: 360px; height: 560px; }
        }

        /* Quick options container spacing */
        #quick-btns { gap: 6px !important; row-gap: 6px !important; }

        .quick-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 18px;
            padding: 6px 12px;
            margin: 0; /* remove extra margins; container gap will handle spacing */
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        /* Compact modal sizes to match reduced chatbot */
        .scheduling-form {
            width: 84vw;
            max-width: 320px;
            max-height: 70vh;
            padding: 14px 16px;
            border-radius: 14px;
            z-index: 1100;
        }
        @media (min-width: 641px) {
            .scheduling-form { width: 72vw; max-width: 340px; max-height: 68vh; }
        }
        @media (min-width: 1025px) {
            .scheduling-form { width: 340px; max-height: 520px; }
        }
        .scheduling-form .form-input { padding: 10px 12px; font-size: 14px; border-radius: 12px; margin-bottom: 10px; }
        .scheduling-form .form-button { padding: 10px 12px; font-size: 14px; border-radius: 12px; }
        .scheduling-form h3 { font-size: 16px; }
        #cancel-form .form-input, #lead-form .form-input { padding: 10px 12px; font-size: 14px; border-radius: 12px; margin-bottom: 10px; }
        #cancel-form .form-button, #lead-form .form-button { padding: 10px 12px; font-size: 14px; border-radius: 12px; }
        /* Improve pre-chat form visibility */
        .form-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); }
        .form-container {
            background: linear-gradient(135deg, #121a38 0%, #1b2550 100%) !important;
            border: 1px solid rgba(255, 255, 255, 0.25) !important;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6), 0 0 30px rgba(102, 126, 234, 0.35) !important;
            padding: 24px !important;
        }
        .form-title { color: #ffffff !important; font-size: 1.4rem !important; }
        .form-subtitle { color: rgba(255, 255, 255, 0.9) !important; font-size: 1rem !important; }
        .form-input {
            background: #ffffff !important;
            color: #0f172a !important;
            border: 1px solid #d1d5db !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        }
        .form-input::placeholder { color: #64748b !important; }
        .form-input:focus {
            border-color: #8b5cf6 !important;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.25) !important;
            background: #ffffff !important;
        }
        .form-button { box-shadow: 0 10px 24px rgba(102, 126, 234, 0.35) !important; }
        .form-button.secondary { color: #e2e8f0; background: rgba(255,255,255,0.08) !important; border-color: rgba(255,255,255,0.2) !important; }
    </style>
</head>
<body class="min-h-screen relative">
    <!-- Navigation Bar -->
    <nav class="flex items-center justify-between px-4 md:px-8 py-4 md:py-6 bg-transparent">
        <div class="flex items-center gap-2 md:gap-3">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                <span class="text-white text-sm md:text-xl font-bold">IM</span>
            </div>
            <span class="text-xl md:text-3xl font-bold text-white">imsolutions</span>
        </div>
        <div class="hidden md:flex gap-4 lg:gap-8 text-white font-medium text-base lg:text-lg">
            <a href="#" class="nav-link">WHAT WE DO</a>
            <a href="#" class="nav-link">BLOG</a>
            <a href="#" class="nav-link">PODCAST</a>
            <a href="#" class="nav-link">CAREERS</a>
        </div>
        <a href="#" class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 text-white font-bold px-4 md:px-8 py-2 md:py-3 rounded-full shadow-lg transition-all duration-300 hover:shadow-xl hover:scale-105 text-sm md:text-base">WORK WITH US</a>
    </nav>

    <!-- Hero Section -->
    <section class="flex flex-col md:flex-row items-center justify-between px-4 md:px-8 lg:px-24 py-12 md:py-20 lg:py-32">
        <div class="max-w-xl text-center md:text-left">
            <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-extrabold text-white leading-tight mb-4 md:mb-6">
                Unlock Your Business Potential With 
                <span class="bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                    AI-Powered Marketing
                </span>
            </h1>
            <p class="text-lg md:text-xl lg:text-2xl text-blue-200 mb-6 md:mb-10">Facebook Premier Level Partner Agency</p>
            <a href="#" class="inline-block bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 text-white font-bold px-6 md:px-10 py-3 md:py-4 rounded-full text-lg md:text-xl shadow-2xl transition-all duration-300 hover:shadow-3xl hover:scale-105 mb-6 md:mb-10">WORK WITH US</a>
            <div class="flex flex-wrap gap-4 md:gap-8 mt-8 md:mt-12 justify-center md:justify-start">
                <div class="stats-card">
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-2 md:mb-3">
                            <span class="text-white text-lg md:text-2xl">üì±</span>
                </div>
                        <span class="text-xs md:text-sm text-gray-300 font-medium">Facebook Premier<br>Level Agency Partner</span>
                </div>
                </div>
                <div class="stats-card">
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-purple-500 to-pink-600 rounded-full flex items-center justify-center mx-auto mb-2 md:mb-3">
                            <span class="text-white text-lg md:text-2xl">üîç</span>
                </div>
                        <span class="text-xs md:text-sm text-gray-300 font-medium">Google Endorsed<br>Marketing Partner</span>
            </div>
        </div>
                <div class="stats-card">
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-pink-500 to-red-600 rounded-full flex items-center justify-center mx-auto mb-2 md:mb-3">
                            <span class="text-white text-2xl">üèÜ</span>
                    </div>
                        <span class="text-sm text-gray-300 font-medium">Forbes Agency<br>Council Member</span>
                    </div>
                    </div>
                <div class="stats-card">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-white text-2xl">üöÄ</span>
                        </div>
                        <span class="text-sm text-gray-300 font-medium">Inc. 5000<br>Fastest Growing Company</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-16 md:mt-0 md:ml-16 flex-1 flex justify-center">
            <div class="hero-gradient relative w-96 h-96 rounded-3xl shadow-2xl flex flex-col items-center justify-center p-8">
                <div class="w-32 h-32 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center mb-6 animate-pulse">
                    <span class="text-white text-6xl">üöÄ</span>
                </div>
                <div class="text-center space-y-4">
                    <div class="stats-card">
                        <span class="text-2xl font-bold text-blue-400">100K+</span>
                        <span class="text-sm text-gray-300">Likes</span>
                    </div>
                    <div class="stats-card">
                        <span class="text-2xl font-bold text-purple-400">$100M+</span>
                        <span class="text-sm text-gray-300">Annual Ad Spend</span>
                    </div>
                    <div class="stats-card">
                        <span class="text-2xl font-bold text-pink-400">15+</span>
                        <span class="text-sm text-gray-300">Years Experience</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Company Stats Section -->
    <section class="flex flex-wrap justify-center gap-6 md:gap-12 px-4 md:px-8 pb-16 md:pb-32">
        <div class="stats-card text-center">
            <span class="text-2xl md:text-4xl font-bold text-white">$100M+</span>
            <span class="text-blue-200 text-xs md:text-sm">In Annual Digital Ad Spend</span>
        </div>
        <div class="stats-card text-center">
            <span class="text-2xl md:text-4xl font-bold text-white">15+</span>
            <span class="text-blue-200 text-xs md:text-sm">Years of Facebook Advertising Experience</span>
        </div>
        <div class="stats-card text-center">
            <span class="text-2xl md:text-4xl font-bold text-white">Inc. 5000</span>
            <span class="text-blue-200 text-xs md:text-sm">Fastest Growing Company</span>
        </div>
        <div class="stats-card text-center">
            <span class="text-2xl md:text-4xl font-bold text-white">Forbes</span>
            <span class="text-blue-200 text-xs md:text-sm">Agency Council Member</span>
        </div>
    </section>

    <!-- Floating Chat Button -->
    <div id="chatbot-toggle" class="fixed bottom-4 right-4 md:bottom-6 md:right-6 z-50">
        <button onclick="openChatbot()" class="glow-effect w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center text-xl md:text-2xl shadow-lg hover:shadow-xl transition-all duration-300">
            <span>üí¨</span>
        </button>
    </div>

    <!-- Chatbot Window (hidden by default) -->
    <div id="chatbot-window" class="hidden">
        <div class="flex items-center justify-between mb-4 p-4 border-b border-white/10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-base">ü§ñ</span>
                </div>
                <div>
                    <span class="font-bold text-white text-lg">IM Solutions AI</span>
                    <div class="text-xs text-gray-300">Your Digital Marketing Assistant</div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTextToSpeech()" class="header-btn" id="tts-toggle" title="Toggle Text-to-Speech">üîä</button>
                <button onclick="refreshChat()" class="header-btn" title="Refresh Chat">üîÑ</button>
                <button onclick="closeChatbot()" class="header-btn" title="Close Chat">‚úï</button>
            </div>
        </div>
        
        <div id="calendar-container"></div>
        
        <div id="chat-messages" class="flex-1 overflow-y-auto mb-4 mx-4 p-4" style="scroll-behavior: smooth; min-height: 0;">
            <div class="message bot-message">
                <div class="flex items-start justify-between">
                    <span class="flex-1">Hey there, marketing rockstar! üöÄ I'm your IM Solutions AI buddy, ready to help you with digital marketing, SEO, social media, and more! What can I help you with today? ‚ú®</span>
                    <button onclick="readMessage(this)" class="read-btn ml-2" title="Read message">üîä</button>
            </div>
        </div>
        </div>
        
        <div id="scheduling-form" class="scheduling-form">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-white">Schedule Appointment</h3>
                <button onclick="cancelScheduling()" class="text-gray-400 hover:text-white">
                    ‚úï
                </button>
            </div>
            <input type="text" id="appointment-title" placeholder="Appointment Title" class="form-input">
            <input type="text" id="appointment-time" placeholder="Select date & time" class="form-input">
            <textarea id="appointment-notes" placeholder="Notes" class="form-input" rows="3"></textarea>
            <div class="flex justify-end space-x-3">
                <button onclick="cancelScheduling()" class="form-button secondary">Cancel</button>
                <button onclick="submitAppointment()" class="form-button">Schedule</button>
            </div>
        </div>
        
        <!-- Cancel Appointment Form -->
        <div id="cancel-form" class="scheduling-form">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-white">Cancel Appointment</h3>
                <button onclick="cancelCancelForm()" class="text-gray-400 hover:text-white">
                    ‚úï
                </button>
            </div>
            <input type="text" id="appointment-id" placeholder="Enter Appointment ID" class="form-input">
            <div class="flex justify-end space-x-3">
                <button onclick="cancelCancelForm()" class="form-button secondary">Cancel</button>
                <button onclick="submitCancellation()" class="form-button">Cancel Appointment</button>
            </div>
        </div>

        <div class="flex mt-auto p-4 border-t border-white/10 bg-white/5 input-row">
            <input id="user-input" type="text" class="flex-1" placeholder="Type your message...">
            <button onclick="toggleVoiceInput()" class="voice-btn" id="voice-btn" title="Voice Input">
                <span>üé§</span>
                <span class="hidden sm:inline">Voice</span>
            </button>
            <button onclick="sendMessage()" class="send-button">Send</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        let loadingDiv = null;
        let calendar = null;
        let recognition = null;
        let isListening = false;
        let speechSynthesis = window.speechSynthesis;
        let leadCapture = { active: false, step: 0, data: {} };
        let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        let userDetails = null;
        let chatbotOpened = false;
        let chatCount = 0; // Track number of user messages
        let dataCollectionMode = false; // Will be activated after 2 chats
        let dataCollectionStep = 0;
        let appointmentFlow = { active: false, step: 0, data: {} };

        // Initialize FullCalendar
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar-container');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next saveButton',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                customButtons: {
                    saveButton: {
                        text: 'Save',
                        click: function() {
                            toggleCalendar();
                        }
                    }
                },
                selectable: true,
                select: function(info) {
                    showSchedulingForm(info.start, info.end);
                },
                eventClick: function(info) {
                    showEventDetails(info.event);
                }
            });

            // Initialize flatpickr for appointment time
            flatpickr("#appointment-time", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                time_24hr: true,
                wrap: false,
                allowInput: true,
                onReady: function(selectedDates, dateStr, instance) {
                    // Add custom Save button if not already present
                    if (!instance.calendarContainer.querySelector('.flatpickr-save')) {
                        const saveBtn = document.createElement('button');
                        saveBtn.textContent = 'Save';
                        saveBtn.type = 'button';
                        saveBtn.className = 'flatpickr-save bg-blue-600 text-white px-3 py-1 rounded ml-2';
                        saveBtn.style.marginLeft = '8px';
                        saveBtn.onclick = function() {
                            instance.close();
                        };
                        // Place the button in the flatpickr footer
                        let fpFooter = instance.calendarContainer.querySelector('.flatpickr-footer');
                        if (!fpFooter) {
                            fpFooter = document.createElement('div');
                            fpFooter.className = 'flatpickr-footer';
                            instance.calendarContainer.appendChild(fpFooter);
                        }
                        fpFooter.appendChild(saveBtn);
                    }
                }
            });

            // Initialize speech recognition
            initSpeechRecognition();
        });

        function toggleCalendar() {
            const calendarContainer = document.getElementById('calendar-container');
            if (calendarContainer.style.display === 'none') {
                calendarContainer.style.display = 'block';
                calendar.render();
            } else {
                calendarContainer.style.display = 'none';
            }
        }

        function showSchedulingForm(start = null, end = null) {
            const form = document.getElementById('scheduling-form');
            form.style.display = 'block';
            if (start && end) {
                document.getElementById('appointment-time').value = start.toISOString().slice(0, 16);
            }
        }

        function cancelScheduling() {
            const form = document.getElementById('scheduling-form');
            form.style.display = 'none';
            document.getElementById('appointment-title').value = '';
            document.getElementById('appointment-time').value = '';
            document.getElementById('appointment-notes').value = '';
        }

        function submitAppointment() {
            const title = document.getElementById('appointment-title').value;
            const time = document.getElementById('appointment-time').value;
            const notes = document.getElementById('appointment-notes').value;

            if (!title || !time) {
                addMessage('üòÖ Missing title or time! Please fill both fields. üìù', false);
                return;
            }

            // Get user data from sessionStorage
            const currentUser = JSON.parse(sessionStorage.getItem('current_user') || '{}');
            
            // Send to server with user information
            fetch('/schedule_appointment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    time: time,
                    notes: notes,
                    user_name: currentUser.name || '',
                    user_email: currentUser.email || '',
                    user_phone: currentUser.phone || '',
                    user_company: currentUser.company || ''
                })
            })
            .then(response => response.json().then(data => ({ status: response.status, data })))
            .then(({ status, data }) => {
                if (status === 409) {
                    // Handle double-booking error
                    const existingTime = new Date(data.existing_appointment.time).toLocaleString();
                    addMessage(`‚è∞ Time slot taken! "${data.existing_appointment.title}" at ${existingTime}. Pick another time! ‚ú®`, false);
                } else if (data.error) {
                    addMessage(`üòÖ ${data.error} Let's try again! üîÑ`, false);
                } else {
                    // Add event to calendar
                    calendar.addEvent({
                        title: title,
                        start: time,
                        description: notes,
                        extendedProps: {
                            appointmentId: data.appointment_id
                        }
                    });
                    addMessage(`üéØ Appointment scheduled! ID: ${data.appointment_id}. See you there! üöÄ`, false);
                    cancelScheduling();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('üòÖ Something went wrong. Let\'s try again! üîÑ', false);
            });
        }

        function showEventDetails(event) {
            const details = `üìÖ ${event.title}\n‚è∞ ${event.start.toLocaleString()}\n${event.extendedProps.description ? 'üìù ' + event.extendedProps.description : ''}`;
            addMessage(details, false);
        }

        function addMessage(message, isUser) {
            if (loadingDiv) {
                loadingDiv.remove();
                loadingDiv = null;
            }
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            if (!isUser) {
                // Add read button for bot messages
                messageDiv.innerHTML = `
                    <div class="flex items-start justify-between">
                        <span class="flex-1">${message}</span>
                        <button onclick="readMessage(this)" class="read-btn ml-3" title="Read message">üîä</button>
                    </div>
                `;
            } else {
            messageDiv.textContent = message;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Only speak bot messages if text-to-speech is enabled
            if (!isUser && document.getElementById('voice-btn').classList.contains('active')) {
                speak(message);
            }
        }

        function readMessage(button) {
            const messageText = button.parentElement.querySelector('span').textContent;
            speak(messageText);
        }

        function showLoading() {
            if (loadingDiv) return;
            loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot-message';
            loadingDiv.id = 'loading-animation';
            loadingDiv.innerHTML = '<span id="dots">ü§î Thinking...</span>';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            animateDots();
        }

        let dotsInterval;
        function animateDots() {
            const dotsSpan = document.getElementById('dots');
            let dotCount = 0;
            clearInterval(dotsInterval);
            dotsInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4;
                dotsSpan.textContent = 'ü§î Thinking' + '.'.repeat(dotCount);
            }, 500);
        }

        function hideLoading() {
            if (loadingDiv) {
                loadingDiv.remove();
                loadingDiv = null;
            }
            clearInterval(dotsInterval);
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            userInput.value = '';

            // Increment chat count
            chatCount++;

            // If we are in lead capture flow, handle locally
            if (leadCapture.active) {
                handleLeadMessage(message);
                return;
            }

            // If we are in data collection mode, handle that first
            if (dataCollectionMode) {
                handleDataCollection(message);
                return;
            }

            // Conversational appointment flow interception
            if (appointmentFlow.active) {
                if (handleAppointmentFlow(message)) {
                    return;
                }
            }

            // Check if it's time to ask for user details (after every 2nd chat)
            if (chatCount % 2 === 0 && chatCount > 0 && !userDetails) {
                startDataCollection();
                return;
            }

            // Check if user wants to share contact info or work with us
            const msgLower = message.toLowerCase();
            const contactTriggers = ['contact', 'share contact', 'work with us', 'get in touch', 'talk to sales', 'quote', 'call me', 'hire you', 'reach out', 'interested', 'help me', 'pricing', 'start project'];
            
            if (contactTriggers.some(t => msgLower.includes(t))) {
                // If we don't have details yet, start collection; otherwise, no extra message
                if (!userDetails || (!userDetails.email && !userDetails.phone)) {
                    startDataCollection();
                }
                return;
            }

            // Detect appointment scheduling intent
            const appointmentTriggers = ['schedule', 'appointment', 'meeting', 'book', 'calendar', 'time slot'];
            if (appointmentTriggers.some(t => msgLower.includes(t))) {
                startAppointmentFlow();
                return;
            }

            // Detect appointment cancellation intent
            const cancelTriggers = ['cancel', 'reschedule', 'change appointment'];
            if (cancelTriggers.some(t => msgLower.includes(t))) {
                showCancelForm();
                return;
            }

            showLoading();

            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    message: message,
                    session_id: sessionId,
                    user_details: userDetails
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                addMessage(data.response, false);
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                addMessage('üòÖ Something went wrong. Let\'s try again! üîÑ', false);
            });
        }

        // Data collection functions
        function startDataCollection() {
            dataCollectionMode = true;
            dataCollectionStep = 0;
            addMessage("üéØ Awesome! Quick favor‚Äîso I can help you like a true marketing sidekick, what should I call you? First name or first + last is perfect. I promise I'll only use it for good. ‚ú®", false);
        }

        function handleDataCollection(message) {
            const text = message.trim();
            
            if (dataCollectionStep === 0) {
                // Name validation - only accept 1-2 words
                const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
                
                if (wordCount === 0) {
                    addMessage("üòÖ Even superheroes need a name! Share yours so I can personalize the journey for you. üìù", false);
                    return;
                } else if (wordCount > 2) {
                    addMessage("üòÖ That's a grand title! Could you share just your first name, or first + last (max 2 words)? Keeps things friendly and neat. üìù", false);
                    return;
                }
                
                // Validate name contains only letters, spaces, and common name characters
                const nameRegex = /^[a-zA-Z\s\-'\.]+$/;
                if (!nameRegex.test(text)) {
                    addMessage("üòÖ I'm picking up some extra characters there. Use only letters, spaces, hyphens, apostrophes, or periods. üìù", false);
                    return;
                }
                
                userDetails = { name: text };
                dataCollectionStep = 1;
                
                // Immediately set session with the user's name so conversations use it
                try {
                    fetch('/set_user_session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: text, email: '', phone: '', company: '' })
                    }).catch(() => {});
                } catch (e) {}
                
                addMessage(`üåü Fantastic, ${text}! Next up‚Äîwhat's the best email to reach you? I'll use it to send relevant updates and zero spam. üìß (You can type 'skip' if you prefer phone)` , false);
                return;
            }
            
            if (dataCollectionStep === 1) {
                if (text.toLowerCase() === 'skip') {
                    userDetails.email = '';
                    dataCollectionStep = 2;
                    addMessage("üì± Great! In that case, what's a good phone number? I'll only reach out with useful, human-approved updates. üìû (or type 'skip')", false);
                    return;
                }
                
                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(text)) {
                    addMessage("üòÖ That email felt a bit shy. Could you share a valid one like name@company.com? Or type 'skip' if you'd prefer phone. üìß", false);
                    return;
                }
                
                userDetails.email = text;
                dataCollectionStep = 2;
                addMessage("üì± Perfect! And your phone number? I won't spam‚Äîjust helpful follow-ups if needed. üìû (or type 'skip')", false);
                return;
            }
            
            if (dataCollectionStep === 2) {
                if (text.toLowerCase() === 'skip') {
                    userDetails.phone = '';
                } else {
                    // Basic phone validation - accept various formats
                    const phoneRegex = /^[\+]?[0-9\s\-\(\)\.]{7,}$/;
                    if (!phoneRegex.test(text)) {
                        addMessage("üòÖ My marketing senses are tingling‚Äîcould you share a valid phone number? Formats like +91 98765 43210 work great. Or type 'skip'. üìû", false);
                        return;
                    }
                    userDetails.phone = text;
                }
                
                // Require at least one contact method
                if (!userDetails.email && !userDetails.phone) {
                    addMessage(`Heads up, ${userDetails.name}! I'll need either an email or a phone number so our team can reach you with the good stuff. üìûüìß`, false);
                    dataCollectionStep = 1;
                    return;
                }
                
                dataCollectionStep = 3;
                addMessage("üíº Final touch‚Äîwhat's your company name? If you're solo or prefer not to share, just type 'skip'. üè¢", false);
                return;
            }
            
            if (dataCollectionStep === 3) {
                if (text.toLowerCase() !== 'skip') {
                    userDetails.company = text;
                }
                
                // Complete data collection
                completeDataCollection();
            }
        }

        function completeDataCollection() {
            // Store user details in sessionStorage
            sessionStorage.setItem('current_user', JSON.stringify(userDetails));
            
            // Send to backend
            fetch('/store_user_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userDetails)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Also set user details into Flask session so conversations carry the name/email/phone
                    fetch('/set_user_session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: userDetails.name || '',
                            email: userDetails.email || '',
                            phone: userDetails.phone || '',
                            company: userDetails.company || ''
                        })
                    }).catch(() => {});
                    
                    addMessage(`üéâ Perfect, ${userDetails.name}! We'll be in touch soon! ‚ú®\n\nWhat else can I help you with? üöÄ`, false);
                } else {
                    addMessage(`üòÖ ${data.error || 'Something went wrong.'} But no worries, let's continue! What can I help you with? üöÄ`, false);
                }
            })
            .catch(error => {
                console.error('Error storing user data:', error);
                addMessage(`üéâ Great, ${userDetails.name}! We've got your details! ‚ú®\n\nWhat else can I help you with? üöÄ`, false);
            });
            
            // Reset data collection mode
            dataCollectionMode = false;
            dataCollectionStep = 0;
        }

        function storeUserDataInBackend() {
            // This function is no longer needed - data is stored directly in completeDataCollection
            console.log('User data storage moved to completeDataCollection function');
        }

        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function closeChatbot() {
            const chatWindow = document.getElementById('chatbot-window');
            chatWindow.classList.add('hidden');
            chatWindow.style.display = 'none';
            
            // Reset chat state
            refreshChat();
        }

        function refreshChat() {
            // Clear chat messages except the initial greeting
            const chatMessages = document.getElementById('chat-messages');
            while (chatMessages.children.length > 1) {
                chatMessages.removeChild(chatMessages.lastChild);
            }
            
            // Reset initial message with read button
            const initialMessage = chatMessages.querySelector('.message.bot-message');
            if (initialMessage) {
                initialMessage.innerHTML = `
                    <div class="flex items-start justify-between">
                        <span class="flex-1">Hey there, marketing rockstar! üöÄ I'm your IM Solutions AI buddy, ready to help you with digital marketing, SEO, social media, and more! What can I help you with today? ‚ú®</span>
                        <button onclick="readMessage(this)" class="read-btn ml-3" title="Read message">üîä</button>
                    </div>
                `;
            }
            
            // Reset all state variables
            userDetails = null;
            chatCount = 0;
            dataCollectionMode = false;
            dataCollectionStep = 0;
            appointmentFlow = { active: false, step: 0, data: {} };
            
            // Clear input field
            document.getElementById('user-input').value = '';
            // Hide any open forms
            document.getElementById('scheduling-form').style.display = 'none';
            document.getElementById('cancel-form').style.display = 'none';
            document.getElementById('calendar-container').style.display = 'none';
            leadCapture = { active: false, step: 0, data: {} };
            
            // Reset text-to-speech state
            const ttsToggle = document.getElementById('tts-toggle');
            const voiceBtn = document.getElementById('voice-btn');
            if (ttsToggle && voiceBtn) {
                ttsToggle.textContent = 'üîä';
                voiceBtn.classList.remove('active');
            }
        }

        // Add responsive handling for window resize
        window.addEventListener('resize', function() {
            const chatWindow = document.getElementById('chatbot-window');
            if (!chatWindow.classList.contains('hidden')) {
                // Ensure proper positioning on resize
                setTimeout(() => {
                    if (window.innerWidth <= 640) {
                        chatWindow.style.width = '95vw';
                        chatWindow.style.height = '80vh';
                    } else if (window.innerWidth <= 1024) {
                        chatWindow.style.width = '85vw';
                        chatWindow.style.maxWidth = '450px';
                        chatWindow.style.height = '70vh';
                    } else {
                        chatWindow.style.width = '400px';
                        chatWindow.style.height = '600px';
                    }
                }, 100);
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Escape key to close chatbot
            if (e.key === 'Escape') {
                if (!document.getElementById('chatbot-window').classList.contains('hidden')) {
                    closeChatbot();
                }
            }
        });

        // Conversational Lead Capture Flow
        function startLeadFlow() {
            // This function is now replaced by startDataCollection
            startDataCollection();
        }

        function handleLeadMessage(text) {
            // This function is now replaced by handleDataCollection
            handleDataCollection(text);
        }

        function showCancelForm() {
            const form = document.getElementById('cancel-form');
            form.style.display = 'block';
        }

        function cancelCancelForm() {
            const form = document.getElementById('cancel-form');
            form.style.display = 'none';
            document.getElementById('appointment-id').value = '';
        }

        function submitCancellation() {
            const appointmentId = document.getElementById('appointment-id').value.trim();

            if (!appointmentId) {
                addMessage('üîç We need the appointment ID! üìù', false);
                return;
            }

            fetch('/cancel_appointment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    appointment_id: appointmentId
                })
            })
            .then(response => response.json().then(data => ({ status: response.status, data })))
            .then(({ status, data }) => {
                if (status === 404) {
                    addMessage(`ü§∑‚Äç‚ôÇÔ∏è ${data.error} üòÖ`, false);
                } else if (data.error) {
                    addMessage(`üòÖ ${data.error} Let's try again! üîÑ`, false);
                } else {
                    addMessage(`‚úÖ Appointment ${data.appointment_id} cancelled! üò¢`, false);
                    cancelCancelForm();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('üòÖ Something went wrong! Let\'s try again! üîÑ', false);
            });
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    userInput.value = transcript;
                    sendMessage();
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('voice-btn').classList.remove('active');
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    document.getElementById('voice-btn').classList.remove('active');
                    addMessage('üé§ Voice recognition issue! Let\'s try again! üí™', false);
                };
            } else {
                console.error('Speech recognition not supported');
                document.getElementById('voice-btn').style.display = 'none';
            }
        }

        // Text-to-Speech helpers (prefer Indian English and strip emojis)
        let preferredVoice = null;
        function loadVoicesAndPick() {
            const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
            if (!voices || !voices.length) return;
            preferredVoice = voices.find(v => (v.lang && v.lang.toLowerCase() === 'en-in'))
                || voices.find(v => /india|indian|en-in/i.test(`${v.name} ${v.lang}`))
                || voices.find(v => /english/i.test(v.lang));
        }
        if (window.speechSynthesis) {
            loadVoicesAndPick();
            window.speechSynthesis.onvoiceschanged = loadVoicesAndPick;
        }

        function stripEmojis(text) {
            try {
                // Remove common emoji ranges and variation selectors
                return text.replace(/[\u{1F300}-\u{1FAFF}\u{1F1E6}-\u{1F1FF}\u2600-\u27BF\uFE0F]/gu, '');
            } catch (e) {
                return text; // Fallback if regex unsupported
            }
        }

        function speak(text) {
            if (speechSynthesis && document.getElementById('tts-toggle').textContent === 'üîá') {
                // Stop any ongoing speech
                speechSynthesis.cancel();
                
                const clean = stripEmojis(text).replace(/\s{2,}/g, ' ').trim();
                const utterance = new SpeechSynthesisUtterance(clean);
                utterance.rate = 0.95; // natural pace
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                if (preferredVoice) utterance.voice = preferredVoice;
                
                // Personality hooks
                utterance.onstart = function() { console.log('üé§ Speaking (Indian English preferred)'); };
                utterance.onend = function() { console.log('üé§ Speech completed'); };
                
                speechSynthesis.speak(utterance);
            }
        }

        function toggleVoiceInput() {
            if (!recognition) {
                initSpeechRecognition();
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('voice-btn').classList.remove('active');
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voice-btn').classList.add('active');
            }
        }

        // Text-to-Speech Toggle
        function toggleTextToSpeech() {
            const ttsToggle = document.getElementById('tts-toggle');
            const voiceBtn = document.getElementById('voice-btn');

            if (speechSynthesis) {
                if (ttsToggle.textContent === 'üîá') {
                    // Turn off TTS
                    speechSynthesis.cancel();
                    ttsToggle.textContent = 'üîä';
                    addMessage("üîá Text-to-speech turned off! I'll be quiet now! ü§´", false);
                } else {
                    // Turn on TTS
                    ttsToggle.textContent = 'üîá';
                    addMessage("üîä Text-to-speech activated! I'll speak with personality! üé§‚ú®", false);
                }
            } else {
                console.error('Speech synthesis not supported');
                voiceBtn.style.display = 'none';
                ttsToggle.style.display = 'none';
            }
        }

        function openChatbot() {
            const chatWindow = document.getElementById('chatbot-window');
            chatWindow.classList.remove('hidden');
            chatWindow.style.display = 'flex';
            setTimeout(() => {
                document.getElementById('user-input').focus();
            }, 100);
        }

        // Conversational appointment scheduling
        function startAppointmentFlow() {
            if (appointmentFlow.active) return;
            appointmentFlow = { active: true, step: 0, data: {} };
            addMessage("üóìÔ∏è Let's get this on the calendar! What's the meeting title? (e.g., 'SEO Strategy Jam')", false);
        }

        async function fetchBookedTimesSet() {
            try {
                const res = await fetch('/get_appointments');
                const data = await res.json();
                const list = (data && data.appointments) ? data.appointments : [];
                const set = new Set();
                list.forEach(a => {
                    if (a && a.time) {
                        try {
                            const iso = new Date(a.time).toISOString();
                            set.add(iso);
                        } catch (e) {
                            // Fallback: best effort
                            set.add(a.time);
                        }
                    }
                });
                return set;
            } catch { return new Set(); }
        }

        function renderSlotGrid(options, bookedSet) {
            // Build date -> slots map
            const byDate = {};
            options.forEach((opt, idx) => {
                const parts = opt.label.split(' ‚Ä¢ ');
                const dateLabel = parts[0];
                const timeLabel = parts[1] || '';
                if (!byDate[dateLabel]) byDate[dateLabel] = [];
                byDate[dateLabel].push({ idx, iso: opt.iso, dateLabel, timeLabel, fullLabel: opt.label });
            });
            const dates = Object.keys(byDate);
            const containerId = 'slot-list-' + Date.now();
            const selectId = containerId + '-date-select';
            const listId = containerId + '-list';

            // Header with date dropdown
            let html = `<div id="${containerId}" style="display:block;margin:12px 12px 4px 12px;">`;
            html += `
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
                    <label for="${selectId}" style="color:#e5e7eb;font-size:14px;">Select date</label>
                    <select id="${selectId}" style="flex:1;background:rgba(255,255,255,0.06);color:#e5e7eb;border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px;">
                        ${dates.map((d, i) => `<option value="${d}" ${i===0?'selected':''}>${d}</option>`).join('')}
                    </select>
                </div>`;

            // Slot list container
            html += `<div id="${listId}"></div>`;
            html += '</div>';

            addMessage('Pick a slot below:', false);
            const lastBot = Array.from(document.querySelectorAll('#chat-messages .bot-message')).pop();
            if (lastBot) {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = html;
                lastBot.appendChild(wrapper.firstChild);
            }

            const listEl = document.getElementById(listId);
            const dateSel = document.getElementById(selectId);

            function renderForDate(dateLabel) {
                if (!listEl) return;
                const daySlots = byDate[dateLabel] || [];
                let inner = '';
                daySlots.forEach(s => {
                    const isBooked = bookedSet.has(s.iso);
                    const btnLabel = isBooked ? 'Sold out' : 'Select';
                    const btnBg = isBooked ? '#d1d5db' : '#ec4899';
                    const btnCursor = isBooked ? 'not-allowed' : 'pointer';
                    const btnOpacity = isBooked ? 0.8 : 1;
                    inner += `
                    <div style="display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:12px 14px;margin-bottom:10px;">
                        <div style="display:flex;flex-direction:column;gap:4px;color:#e5e7eb;">
                            <div style="font-weight:700;color:#ffffff;">${s.dateLabel}</div>
                            <div style="font-size:12px;color:#cbd5e1;">${s.timeLabel}</div>
                        </div>
                        <button data-idx="${s.idx}" data-iso="${s.iso}" data-booked="${isBooked? '1':'0'}" style="min-width:96px;padding:8px 14px;border:none;border-radius:10px;background:${btnBg};color:#ffffff;cursor:${btnCursor};opacity:${btnOpacity};font-weight:700;">${btnLabel}</button>
                    </div>`;
                });
                listEl.innerHTML = inner || '<div style="color:#cbd5e1;">No slots for this date.</div>';
            }

            // Initial render
            renderForDate(dates[0]);

            if (dateSel) {
                dateSel.addEventListener('change', () => {
                    renderForDate(dateSel.value);
                });
            }

            if (listEl) {
                listEl.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-iso]');
                    if (!btn) return;
                    const isBooked = btn.getAttribute('data-booked') === '1';
                    const idx = parseInt(btn.getAttribute('data-idx'), 10);
                    const chosen = options[idx];
                    if (!chosen) return;
                    if (isBooked) {
                        addMessage(`üö´ That slot (${chosen.label}) is already booked. Try another date/time.`, false);
                        return;
                    }
                    addMessage(`‚úÖ That slot (${chosen.label}) is available!`, false);
                    appointmentFlow.data.timeISO = chosen.iso;
                    appointmentFlow.step = 2;
                    addMessage("Any notes for us? (optional ‚Äî type 'skip') ‚úçÔ∏è", false);
                });
            }
        }

        function handleAppointmentFlow(message) {
            const text = (message || '').trim();
            if (!appointmentFlow.active) return false;

            // Step 0: Title
            if (appointmentFlow.step === 0) {
                if (!text) { addMessage("Give me a short, spicy title ‚úçÔ∏è", false); return true; }
                appointmentFlow.data.title = text;
                appointmentFlow.step = 1;
                // Show weekday slots for next 10 days
                const options = generateSlotsNext10Days();
                if (!options.length) {
                    addMessage("Hmm, my calendar is taking the weekend off. Try again on a weekday! üòÖ", false);
                    appointmentFlow = { active: false, step: 0, data: {} };
                    return true;
                }
                appointmentFlow.data.slotOptions = options;
                fetchBookedTimesSet().then(bookedSet => {
                    renderSlotGrid(options, bookedSet || new Set());
                });
                return true;
            }

            // Step 1 is handled by clicking a slot button
            if (appointmentFlow.step === 1) {
                addMessage("Tap one of the green slots above to continue üëÜ", false);
                return true;
            }

            // Step 2: Notes and submit
            if (appointmentFlow.step === 2) {
                appointmentFlow.data.notes = (text.toLowerCase() === 'skip') ? '' : text;
                const payload = {
                    title: appointmentFlow.data.title,
                    time: appointmentFlow.data.timeISO,
                    notes: appointmentFlow.data.notes || ''
                };
                showLoading();
                fetch('/schedule_appointment', {
                method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(r => r.json())
            .then(data => {
                    hideLoading();
                    if (data && data.appointment_id) {
                        const when = new Date(appointmentFlow.data.timeISO).toLocaleString();
                        // Remove the selected slot from the visible list to avoid confusion
                        try {
                            const selIso = appointmentFlow.data.timeISO;
                            const btn = document.querySelector(`button[data-iso="${selIso}"]`);
                            if (btn) {
                                const card = btn.closest('div');
                                if (card && card.parentElement) {
                                    card.parentElement.removeChild(card);
                                }
                            }
                        } catch (e) {}
                        addMessage(`‚úÖ Boom! Your slot is locked. ID: ${data.appointment_id}. See you on ${when}. I'll bring the digital donuts üç©`, false);
                } else {
                        addMessage("üòÖ I fumbled the calendar save. Mind trying again?", false);
                    }
                })
                .catch(() => { hideLoading(); addMessage(`üåê Tiny network gremlin. Let's try that again!`, false); })
                .finally(() => { appointmentFlow = { active: false, step: 0, data: {} }; });
                return true;
            }
            return false;
        }

        function generateSlotsNext10Days() {
            const slots = [];
            const daySlots = [
                { h:9,  m:0,  label:'9:00‚Äì10:00 AM' },
                { h:11, m:0,  label:'11:00‚Äì12:00' },
                { h:13, m:0,  label:'1:00‚Äì2:00 PM' },
                { h:16, m:0,  label:'4:00‚Äì5:00 PM' }
            ];
            const now = new Date();
            for (let d = 0; d < 10; d++) {
                const base = new Date(now.getFullYear(), now.getMonth(), now.getDate() + d);
                const day = base.getDay(); // 0 Sun, 6 Sat
                if (day === 0 || day === 6) continue; // skip weekends
                const dateLabel = base.toLocaleDateString();
                daySlots.forEach(s => {
                    const start = new Date(base.getFullYear(), base.getMonth(), base.getDate(), s.h, s.m, 0);
                    const iso = start.toISOString();
                    slots.push({ iso, label: `${dateLabel} ‚Ä¢ ${s.label}` });
                });
            }
            return slots;
        }

        // Ensure global access for onclick handlers
        window.openChatbot = openChatbot;
    </script>
</body>
</html> 